# GCode Proxy Server Configuration
# 
# This file configures the GCode proxy server that forwards GCode commands
# from TCP clients to USB serial devices.
#
# Configuration precedence (highest to lowest):
# 1. Environment variables
# 2. CLI arguments
# 3. This config file
# 4. Default values
#
# Copy this file to ~/.config/gcode-proxy/config.yaml
# or specify a custom path with --config or GCODE_PROXY_CONFIG env variable

server:
  # TCP server port
  # Environment variable: SERVER_PORT
  port: 8080
  
  # TCP server bind address
  # Use 0.0.0.0 to listen on all interfaces
  # Use 127.0.0.1 to only accept local connections
  # Environment variable: SERVER_ADDRESS
  address: 0.0.0.0
  
  # Maximum number of commands allowed in the queue
  # When the queue reaches this limit, new commands are rejected with an error
  # Environment variable: SERVER_QUEUE_LIMIT
  queue-limit: 50

device:
  # USB device ID in vendor:product format
  # Find your device ID using: lsusb (Linux) or Device Manager (Windows)
  # Environment variable: DEVICE_USB_ID
  usb-id: 303a:4001
  
  # Device path as alternative to usb-id, overrides usb-id
  # Environment variable: DEVICE_DEV_PATH
  #path: /dev/ttyACM0
  
  # Serial baud rate for the USB device
  # Common values: 9600, 19200, 38400, 57600, 115200, 250000
  # Environment variable: DEVICE_BAUD_RATE
  baud-rate: 115200
  
  # Device initialization delay in seconds
  # Some devices need time to initialize after connection
  # Environment variable: DEVICE_SERIAL_DELAY
  serial-delay: 0.1
  
  # Timeout in seconds for waiting for device response
  # Increase this value if your device needs more time to respond to commands
  # Environment variable: DEVICE_RESPONSE_TIMEOUT
  response-timeout: 30.0

  # Normalize GRBL responses by cleaning ESP logs
  # When enabled, ESP log output that clobbers serial communication is removed,
  # ensuring clean GRBL responses are sent to clients. This is enabled by default
  # but can be disabled if it causes issues with your specific device.
  # Environment variable: DEVICE_NORMALIZE_GRBL_RESPONSES
  normalize-grbl-responses: true

# GCode communication log file
# Optional path to a file where all GCode commands sent to the device
# and responses received from the device will be logged.
# Log entries include timestamp and source (client address or 'device').
# If the file exists, new entries are appended to the end.
# Environment variable: GCODE_LOG_FILE
gcode-log-file: gcode.log

# Custom triggers for executing external commands in response to GCode patterns
# Triggers allow you to integrate external systems (scripts, Home Assistant, etc.)
# All trigger execution is asynchronous and non-blocking
# See TRIGGERS.md for detailed documentation
custom-triggers:
  # Trigger behavior modes:
  #   forward (default): Send gcode to device, execute trigger async, return device response
  #   capture: Don't send gcode to device, execute trigger, return fake response (ok or error)
  #   capture-nowait: Don't send gcode to device, execute trigger async, return ok immediately
  
  # Example: Air assist on (M8 command)
  - id: air-assist-on
    trigger:
      type: gcode
      match: M8
    command: "hass-cli service call homeassistant.turn_on --arguments entity_id=switch.laser_air_assist"
  
  # Example: Air assist off (M9 command)
  - id: air-assist-off
    trigger:
      type: gcode
      match: M9
      behavior: capture-nowait
    command: "hass-cli service call homeassistant.turn_off --arguments entity_id=switch.laser_air_assist"
    
  # Example: Air vent on (M7 command)
  - id: air-vent-on
    trigger:
      type: gcode
      match: M7
    command: "hass-cli service call homeassistant.turn_on --arguments entity_id=fan.laser_vent"

  # Example: Air vent off (M7.1 or M9 command)
  - id: air-vent-off
    trigger:
      type: gcode
      match: (M7\.1)|(M9)
    command: "hass-cli service call homeassistant.turn_off --arguments entity_id=fan.laser_vent"
