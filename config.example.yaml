# GCode Proxy Server Configuration
#
# This file configures the GCode proxy server that forwards GCode commands
# from TCP clients to USB serial devices.
#
# Configuration precedence (highest to lowest):
# 1. Environment variables
# 2. CLI arguments
# 3. This config file
# 4. Default values
#
# Copy this file to ~/.config/gcode-proxy/config.yaml
# or specify a custom path with --config or GCODE_PROXY_CONFIG env variable

server:
  # TCP server port
  # Environment variable: SERVER_PORT
  port: 8080

  # TCP server bind address
  # Use 0.0.0.0 to listen on all interfaces
  # Use 127.0.0.1 to only accept local connections
  # Environment variable: SERVER_ADDRESS
  address: 0.0.0.0

  # Maximum number of commands allowed in the queue
  # When the queue reaches this limit, new commands are rejected with an error
  # Environment variable: SERVER_QUEUE_LIMIT
  queue-limit: 1000

device:
  # USB device ID in vendor:product format
  # Find your device ID using: lsusb (Linux) or Device Manager (Windows)
  # Environment variable: DEVICE_USB_ID
  usb-id: 303a:4001

  # Device path as alternative to usb-id, overrides usb-id
  # Environment variable: DEVICE_DEV_PATH
  #path: /dev/ttyACM0

  # Serial baud rate for the USB device
  # Common values: 9600, 19200, 38400, 57600, 115200, 250000
  # Environment variable: DEVICE_BAUD_RATE
  baud-rate: 115200

  # Device initialization delay in ms
  # Some devices need time to initialize after connection
  # Environment variable: DEVICE_SERIAL_DELAY
  serial-delay: 100 #ms

  # Timeout in ms for waiting for device response
  # Increase this value if your device needs more time to respond to commands
  # Environment variable: DEVICE_RESPONSE_TIMEOUT
  response-timeout: 120000.0 #ms

  # Period in ms for pinging device with `?` command
  # The `?` command requests a status report from the device, allowing the proxy
  # to track device state (machine position, work position, buffer status, etc.).
  # Default: 1000ms (1Hz). Set to 0 to disable liveness probing.
  # Environment variable: DEVICE_LIVENESS_PERIOD
  liveness-period: 1000 #ms

  # Suppress 'ok' responses from `?` commands
  # Some GRBL devices respond with 'ok' to the `?` status request command, which is
  # non-standard and conflicts with the buffer fill character counting algorithm.
  # When enabled (default), these unexpected 'ok' responses are swallowed and not
  # counted towards buffer management. Set to false if your device doesn't emit
  # these responses, or if you need the status request 'ok' responses for other reasons.
  # Environment variable: DEVICE_SWALLOW_REALTIME_OK
  swallow-realtime-ok: true

  # Status query behavior mode
  # Determines how the proxy handles status queries (?) from clients
  #
  # Modes:
  #   liveness-cache:
  #     - Proxy maintains internal status cache from periodic device probes (at `liveness-period` intervals)
  #     - Client status queries are served immediately from cache
  #     - Faster response times, predictable status update intervals
  #     - Good for high-throughput scenarios
  #
  #   forward (default):
  #     - Client status queries are forwarded directly to the device
  #     - Always provides fresh, real-time device state
  #     - Slightly higher latency due to device communication
  #     - Good for accuracy-critical or low-throughput scenarios
  #
  # Environment variable: DEVICE_STATUS_BEHAVIOR
  status-behavior: forward


# GCode communication log file
# Optional path to a file where all GCode commands sent to the device
# and responses received from the device will be logged.
# Log entries include timestamp and source (client address or 'device').
# If the file exists, new entries are appended to the end.
# Environment variable: GCODE_LOG_FILE
gcode-log-file: gcode.log
tcp-log-file: tcp.log

# Custom triggers for executing external commands in response to GCode patterns
# Triggers allow you to integrate external systems (scripts, Home Assistant, etc.)
# All trigger execution is asynchronous and non-blocking
# See TRIGGERS.md for detailed documentation
custom-triggers:
  # Trigger Template:

  # - id: air-assist-on # -- trigger name for logging
  #   trigger:
  #     type: gcode # -- trigger type (only gcode for now)
  #     match: M8 # -- regex pattern to match on gcode occurrence

  #     behavior: "" # -- [ forward | capture | capture-nowait ]
  ##      -- forward: Send gcode to device, execute trigger async, return device response
  ##      -- capture (default): Don't send gcode to device, execute trigger, return fake response (ok or error)
  ##      -- capture-nowait: Don't send gcode to device, execute trigger async, return ok immediately

  #     synchronize: false # -- whether to force execution timing synchronization (default: false)
  #       -- If true, the trigger injects a `G4 P0` command to the device and waits for a response
  #          before executing the trigger. This forces all prior commands in the device device buffer
  #          to finish before trigger command execution.

  #   command: "" # -- shell command to execute on trigger

  # Example: Air assist on (M8 command)
  - id: air-assist-on
    trigger:
      type: gcode
      match: M8
    command: "hass-cli service call homeassistant.turn_on --arguments entity_id=switch.laser_air_assist"

  # Example: Air assist off (M9 command)
  - id: air-assist-off
    trigger:
      type: gcode
      match: M9
    command: "hass-cli service call homeassistant.turn_off --arguments entity_id=switch.laser_air_assist"

  # Example: Air vent on (M7 command)
  - id: air-vent-on
    trigger:
      type: gcode
      match: M7$
    command: "hass-cli service call homeassistant.turn_on --arguments entity_id=fan.laser_vent"

  # Example: Air vent off (M7.1 or M9 command)
  - id: air-vent-off
    trigger:
      type: gcode
      match: M7\.1
    command: "hass-cli service call homeassistant.turn_off --arguments entity_id=fan.laser_vent"

  # Example: Job end notification (M2 or M30 command)
  - id: job-end-notification
    trigger:
      type: gcode
      match: (M2$)|(M30$)
      behavior: forward # Don't eat the command
      synchronize: false
    command: "pb push -t 'Laser Job Completed' 'Laser cutting/engraving job has finished.'"

  # Example: Power off when idle
  - id: idle-power-off
    trigger:
      type: state
      match: Idle
      delay: 300 #s (5 minutes)
    command: "hass-cli service call homeassistant.turn_off --arguments entity_id=switch.laser_power"

  # Example: Power on when requested
  - id: power-on
    trigger:
      type: gcode
      match: .*  # -- matches any gcode that is not a status query
      state: Disconnected
      behavior: forward # Don't eat the command
      synchronize: false
    command: "hass-cli service call homeassistant.turn_on --arguments entity_id=switch.laser_power"
